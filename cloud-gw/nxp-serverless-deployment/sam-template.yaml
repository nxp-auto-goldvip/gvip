# SPDX-License-Identifier: BSD-3-Clause
# Copyright 2021 NXP

AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31
Description: A stack that deploys a greengrass group, a lambda function working with the group, subscriptions, and a rule to route message to sitewise.

Parameters:
  TelemetryTopic:
    Default: s32g/linux/telemetry
    Type: String
    Description: Topic for the MQTT messages.
  ContactEmail:
    Default: example@mail.com
    Type: String
    Description: Contact email for Sitewise project

Metadata:
  AWS::ServerlessRepo::Application:
    Name: nxp-goldvip-telemetry
    Description: Telemetry use-case for GoldVIP
    Author: NXP
    SpdxLicenseId: BSD-3-Clause
    LicenseUrl: LICENSE
    ReadmeUrl: ../README.rst
    Labels: ['nxp', 'goldvip', 's32g']
    HomePageUrl: https://source.codeaurora.org/external/autobsps32/goldvip/gvip
    SemanticVersion: 0.6.0
    SourceCodeUrl: https://source.codeaurora.org/external/autobsps32/goldvip/gvip

Resources:
### S3 Bucket ###
  CertStorage:
    Type: AWS::S3::Bucket
    Properties:
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        IgnorePublicAcls: false
        BlockPublicPolicy: true
        RestrictPublicBuckets: true

### Policies ###
  CertificatePolicy:
    Type: AWS::IoT::Policy
    Properties:
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Action: iot:Connect
          Resource: !Join [ ":", [ "arn:aws:iot", !Ref "AWS::Region", !Ref "AWS::AccountId", "client/*" ] ]
        - Effect: Allow
          Action:
            - iot:Publish
            - iot:Subscribe
            - iot:Receive
          Resource:
            - !Join [ ":", [ "arn:aws:iot", !Ref "AWS::Region", !Ref "AWS::AccountId", "topicfilter/*" ] ]
            - !Join [ ":", [ "arn:aws:iot", !Ref "AWS::Region", !Ref "AWS::AccountId", "topic/*" ] ]
        - Effect: Allow
          Action:
            - iot:GetThingShadow
            - iot:UpdateThingShadow
            - iot:DeleteThingShadow
          Resource: !Join
            - ':'
            - - 'arn:aws:iot'
              - !Ref 'AWS::Region'
              - !Ref 'AWS::AccountId'
              - !Join
                - "/"
                - - thing
                  - !Join
                   - ""
                   - - !Ref 'AWS::StackName'
                     - "*"
        - Effect: Allow
          Action:
            - greengrass:AssumeRoleForGroup
            - greengrass:CreateCertificate
          Resource: "*"
        - Effect: Allow
          Action:
            - greengrass:GetDeployment
            - greengrass:GetDeploymentArtifacts
            - greengrass:UpdateCoreDeploymentStatus
          Resource: !Join
            - ':'
            - - 'arn:aws:greengrass'
              - !Ref 'AWS::Region'
              - !Ref 'AWS::AccountId'
              - "/greengrass/groups/*/deployments/*"
        - Effect: Allow
          Action:
            - greengrass:Discover
            - greengrass:PutCertificateAuthorities
            - greengrass:VerifyClientDeviceIdentity
            - greengrass:VerifyClientDeviceIoTCertificateAssociation
            - greengrass:GetConnectivityInfo
            - greengrass:UpdateConnectivityInfo
          Resource: !Join
            - ':'
            - - 'arn:aws:iot'
              - !Ref 'AWS::Region'
              - !Ref 'AWS::AccountId'
              - !Join
                - "/"
                - - thing
                  - "*"
      PolicyName: !Join
       - "_"
       - - !Ref 'AWS::StackName'
         - Cert
         - Policy

### Roles ###
  LambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - lambda.amazonaws.com
            Action:
              - sts:AssumeRole

  LambdaBasicExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
        - Effect: Allow
          Principal:
            Service: lambda.amazonaws.com
          Action: sts:AssumeRole
      Path: /
      Policies:
        - PolicyName: CustomLambdaDescribePolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - logs:CreateLogGroup
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: arn:aws:logs:*:*:*
              - Effect: Allow
                Action:
                  - iot:*
                  - s3:*
                  - iotsitewise:*
                  - events:*
                  - lambda:*
                  - greengrass:*
                  - iam:*
                  - sso:*
                Resource: '*'

  SitewiseRuleRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - iot.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: TelemetrySitewiseRuleRole
          PolicyDocument:
            Version: 2012-10-17
            Statement:
            - Effect: Allow
              Resource: '*'
              Action: 'iotsitewise:BatchPutAssetPropertyValue'

  SitewisePortalRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
              - monitor.iotsitewise.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: TelemetrySitewiseRuleRole
          PolicyDocument:
            Version: 2012-10-17
            Statement:
            - Effect: Allow
              Action:
                - 'iotsitewise:*'
                - 'sso-directory:DescribeUsers'
                - 'iotevents:DescribeAlarmModel'
              Resource: '*'
            - Effect: Allow
              Action:
                - 'iotevents:BatchAcknowledgeAlarm'
                - 'iotevents:BatchSnoozeAlarm'
              Resource: '*'
              Condition:
                'Null':
                  'iotevents:keyValue': 'false'

  GreengrassServiceRole:
    Type: 'AWS::IAM::Role'
    DeletionPolicy: Retain
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service: greengrass.amazonaws.com
            Action:
              - sts:AssumeRole
      Policies:
        - PolicyName: !Join
           - "_"
           - - !Ref 'AWS::StackName'
             - GreengrassServiceRole
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Effect: Allow
                Action:
                  - 'iot:*'
                  - 'greengrass:*'
                  - 'lambda:GetFunction'
                  - 'lambda:GetFunctionConfiguration'
                  - 's3:GetObject'
                  - 's3:GetBucketLocation'
                  - 'sagemaker:DescribeTrainingJob'
                  - 'secretsmanager:GetSecretValue'
                Resource: '*'

### Functions ###
  Telemetry:
    Type: AWS::Serverless::Function
    Properties:
      Runtime: python3.8
      Role: !GetAtt 'LambdaRole.Arn'
      Handler: telemetry_lambda.function_handler
      CodeUri: ../aws-lambda-functions/telemetry-function/domU/
      Description: Invoke a function during stack creation.
  TelemetryVersion:
    Type: AWS::Lambda::Version
    Properties:
      FunctionName: !Ref Telemetry
  TelemetryVersionAlias:
    Type: AWS::Lambda::Alias
    Properties:
      FunctionName: !Ref Telemetry
      FunctionVersion: !GetAtt TelemetryVersion.Version
      Name: Prod

  GreengrassCustomFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: nxp_cfn_gg_custom_function.lambda_handler
      Description: "Creates: a thing, a thing policy, a greengrass group, an asset model, an asset, a sitewise portal, project and dashboard"
      Timeout: 700
      Role: !GetAtt 'LambdaBasicExecutionRole.Arn'
      Runtime: python3.8
      CodeUri: ../cfn-custom-functions/
    DependsOn: SitewisePortalRole

  CertificateCustomFunction:
    Type: AWS::Serverless::Function
    Properties:
      Handler: nxp_cfn_cert_custom_function.lambda_handler
      Description: "Creates a certificate for greengrass and stores it in a S3 bucket."
      Timeout: 30
      Role: !GetAtt 'LambdaBasicExecutionRole.Arn'
      Runtime: python3.8
      CodeUri: ../cfn-custom-functions/

### Things ###
  GoldVIPCore:
    Type: 'AWS::IoT::Thing'
    Properties:
      ThingName: !Join
       - "_"
       - - !Ref 'AWS::StackName'
         - CoreThing

  SjaThing:
    Type: 'AWS::IoT::Thing'
    Properties:
      ThingName: !Join
       - "_"
       - - !Ref 'AWS::StackName'
         - SjaThing

### Custom Resources ###
  GreengrassCustomResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt 'GreengrassCustomFunction.Arn'
      ThingArn: !Join
        - ':'
        - - 'arn:aws:iot'
          - !Ref 'AWS::Region'
          - !Ref 'AWS::AccountId'
          - !Join
            - "/"
            - - thing
              - !Ref GoldVIPCore
      SjaThingArn: !Join 
        - ':'
        - - 'arn:aws:iot'
          - !Ref 'AWS::Region'
          - !Ref 'AWS::AccountId'
          - !Join
            - "/"
            - - thing
              - !Ref SjaThing
      Region: !Ref 'AWS::Region'
      StackName: !Ref 'AWS::StackName'
      AccountId: !Ref 'AWS::AccountId'
      TelemetryTopic: !Ref TelemetryTopic
      CertificateArn: !GetAtt CertificateCustomResource.gg_certificateArn
      SjaThingCertArn: !GetAtt CertificateCustomResource.sja_certificateArn
      TelemetryLambdaArn: !Ref TelemetryVersionAlias
      ContactEmail: !Ref ContactEmail
      PortalRoleArn: !GetAtt SitewisePortalRole.Arn
      ServiceRoleArn: !GetAtt GreengrassServiceRole.Arn
      ServiceRoleName: !Ref GreengrassServiceRole
      ServiceRolePolicyName:  !Join
           - "_"
           - - !Ref 'AWS::StackName'
             - GreengrassServiceRole

  CertificateCustomResource:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt 'CertificateCustomFunction.Arn'
      BucketName: !Ref CertStorage
      ThingArn:  !Join
        - ':'
        - - 'arn:aws:iot'
          - !Ref 'AWS::Region'
          - !Ref 'AWS::AccountId'
          - !Join
            - "/"
            - - thing
              - !Ref GoldVIPCore
      Region: !Ref 'AWS::Region'
      GGCoreName: !Ref GoldVIPCore
      SjaThingName: !Ref SjaThing
      PolicyName: !Ref CertificatePolicy

### Sitewise Rules ###
  SitewiseTopicSjaRule:
    Type: AWS::IoT::TopicRule
    Properties:
      TopicRulePayload:
        RuleDisabled: false
        Sql: !Join
         - "'"
         - - "SELECT * FROM"
           - !Join
             - "/"
             - - "s32g/sja/switch"
               - !Ref "AWS::StackName"
           - " "
        Actions:
        - IotSiteWise:
            RoleArn:
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p0.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p0
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p0.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p0
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p0.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p0
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p0.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p0
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p0.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p0
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p0.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p0
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p1.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p1
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p1.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p1
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p1.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p1
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p1.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p1
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p1.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p1
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p1.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p1
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p2.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p2
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p2.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p2
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p2.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p2
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p2.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p2
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p2.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p2
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p2.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p2
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p3.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p3
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p3.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p3
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p3.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p3
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p3.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p3
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p3.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p3
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p3.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p3
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p4.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p4
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p4.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p4
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p4.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p4
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p4.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p4
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p4.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p4
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p4.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p4
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p5.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p5
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p5.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p5
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p5.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p5
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p5.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p5
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p5.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p5
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p5.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p5
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p6.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p6
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p6.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p6
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p6.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p6
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p6.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p6
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p6.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p6
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p6.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p6
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p7.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p7
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p7.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p7
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p7.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p7
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p7.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p7
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p7.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p7
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p7.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p7
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p8.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p8
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p8.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p8
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p8.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p8
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p8.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p8
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p8.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p8
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p8.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p8
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p9.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p9
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p9.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p9
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p9.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p9
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p9.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p9
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p9.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p9
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p9.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p9
  SitewiseTopicSjaRule2: # Second sja rule; rules are limited to 10 actions.
    Type: AWS::IoT::TopicRule
    Properties:
      TopicRulePayload:
        RuleDisabled: false
        Sql: !Join
         - "'"
         - - "SELECT * FROM"
           - !Join
             - "/"
             - - "s32g/sja/switch"
               - !Ref "AWS::StackName"
           - " "
        Actions:
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p10.DropEventsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_counter_s0_p10
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p10.IngressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_counter_s0_p10
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p10.EgressPktsCounter}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_counter_s0_p10
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p10.DropEventsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /drop_delta_s0_p10
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p10.IngressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /ingress_delta_s0_p10
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${s0.p10.EgressPktsDelta}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /egress_delta_s0_p10
  SitewiseTopicRule:
    Type: AWS::IoT::TopicRule
    Properties:
      TopicRulePayload:
        RuleDisabled: false
        Sql: !Join
         - "'"
         - - SELECT * FROM 
           - !Ref TelemetryTopic
           - " "
        Actions:
        - IotSiteWise:
            RoleArn: 
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${cpu_idle}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /cpu_idle
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${cpu0_idle}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /cpu0_idle
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${cpu1_idle}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /cpu1_idle
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${cpu2_idle}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /cpu2_idle
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${cpu3_idle}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /cpu3_idle
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${mem_Load}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /memory_load
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${pfe0_Receive_bps}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /pfe0_rx_bps
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${pfe0_Transmit_bps}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /pfe0_tx_bps
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${pfe2_Receive_bps}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /pfe2_rx_bps
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${pfe2_Transmit_bps}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /pfe2_tx_bps
        - IotSiteWise:
            RoleArn:
              Fn::GetAtt:
              - SitewiseRuleRole
              - Arn
            PutAssetPropertyValueEntries:
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${m7_0}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /m7_0
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${m7_1}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /m7_1
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${m7_2}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /m7_2
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${immediate_temperature_0}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /immediate_temperature_0
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${immediate_temperature_1}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /immediate_temperature_1
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${immediate_temperature_2}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /immediate_temperature_2
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${average_temperature_0}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /average_temperature_0
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${average_temperature_1}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /average_temperature_1
            - PropertyValues:
              - Timestamp:
                  TimeInSeconds: ${floor(timestamp() / 1E3)}
                Value:
                  DoubleValue: ${average_temperature_2}
              PropertyAlias: !Join
                - ""
                - - /telemetry/
                  - !Ref 'AWS::StackName'
                  - /average_temperature_2

### Outputs ###
Outputs:
  GreengrassGroupId:
    Value: !GetAtt GreengrassCustomResource.GroupId
  CertificateBucket:
    Value: !Ref CertStorage
  SitewisePortalId:
    Value: !GetAtt GreengrassCustomResource.portalId
  SitewisePortalUrl:
    Value: !GetAtt GreengrassCustomResource.portalUrl
  SitewiseDashboardId:
    Value: !GetAtt GreengrassCustomResource.dashboard1Id
  SitewiseSJADashboard1Id:
    Value: !GetAtt GreengrassCustomResource.dashboard2Id
  SitewiseSJADashboard2Id:
    Value: !GetAtt GreengrassCustomResource.dashboard3Id
  SitewiseSJADashboard3Id:
    Value: !GetAtt GreengrassCustomResource.dashboard4Id
  SitewiseProjectId:
    Value: !GetAtt GreengrassCustomResource.projectId
  SitewiseAssetId:
    Value: !GetAtt GreengrassCustomResource.assetId
  SitewiseAssetModelId:
    Value: !GetAtt GreengrassCustomResource.assetModelId
